# Pulled this file from SE2
# Name of the workflow
name: Integration tests # commented out the Unit tests for now
# This work flow is triggered when pull requests are opened or updated
on: [ pull_request ]
# A workflow run is made up of one or more jobs.
# jobs:
#   # id of job, a string that is unique to the "jobs" node above.
#   test:
#     # Creates a build matrix for your jobs. You can define different
#     # variations of an environment to run each job in.
#     strategy:
#       # A set of different configurations of the virtual  
#       # environment.
#       matrix:
#         device:
#         - "iPhone 11 Pro Max (14.4)"
#       # When set to true, GitHub cancels all in-progress jobs if any        
#       # matrix job fails.
#       fail-fast: true
#     # The type of machine to run the job on.
#     runs-on: macOS-latest
#     # Contains a sequence of tasks.
#     steps:
#     # This step lists all available simulators
#     - name: "List all simulators"
#       run: "xcrun xctrace list devices"
#     # This step specifically finds and starts the Iphone 11 Pro Max Simulator
#     - name: "Start Simulator"
#       run: |
#           IPHONE11=$(xcrun xctrace list devices  2>&1  | grep -m 1 "iPhone 11 Pro Max" | awk -F'[()]' '{print $4}')
#           xcrun simctl boot $IPHONE11
#     # The branch or tag ref that triggered the workflow will be 
#     # checked out.
#     # https://github.com/actions/checkout
#     - uses: actions/checkout@v2
#     # Sets up a flutter environment.
#     # https://github.com/marketplace/actions/flutter-action
#     - uses: subosito/flutter-action@v2
#       with:
#         architecture: x64
#         channel: 'stable' # or: 'dev' or 'beta'
#     # - name: Run Unit Tests
#       # run: flutter test
#     - name: "Run Flutter Driver tests"
#       run: "flutter drive --target=test_driver/app.dart"

# jobs:
#   build_and_test:
#     runs-on: ubuntu-latest

#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v2

#     # - name: Set up Java
#     #   uses: actions/setup-java@v2
#     #   with:
#     #     java-version: '12.x'

#     - name: Set up Flutter
#       uses: subosito/flutter-action@v2

#     - name: Install dependencies
#       run: flutter pub get

#     - name: Install emulator
#       uses: android-actions/setup-android-emulator@v2
#       with:
#         api-level: 30
#         target: default
#         tag: google_apis
#         arch: x86_64
#         profile: default
#         emulator-version: 30.7.5
#         force: true

#     # - name: Start emulator
#     #   uses: android-actions/start-android-emulator@v2

#     # - name: Wait for emulator
#     #   run: adb wait-for-device      

#     - name: Run tests on Android
#       run: flutter drive --target=test_driver/app.dart -d emulator-5554

jobs:
  flutter_test:
    name: Run flutter 
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-java@v1
      with:
        java-version: "12.x"
    - uses: subosito/flutter-action@v2
      with:
        channel: "stable"
    - run: flutter pub get

  build_appbundle:
    name: Build Flutter (Android)
    needs: [flutter_test]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-java@v1
      with:
        java-version: "12.x"
    - uses: subosito/flutter-action@v2
      with:
        channel: "stable"
    - run: flutter pub get
    - run: flutter clean
    - run: flutter build appbundle
    - run: "flutter drive --target=test_driver/app.dart"